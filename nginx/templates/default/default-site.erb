http {
  server {
      listen 80;

      server_name <%= node[:hostname] %>;
      client_max_body_size 8M;
      root <%= node[:deploy][:deploy_to] %>/current/public;
      try_files $uri $uri/ $uri/index.html $uri.html @unicorn;
      location @unicorn {
          proxy_pass http://unicorn;
      }
  }

  upstream unicorn {
    <% 4.times do |w| %>
        listen "/tmp/unicorn.<%= w %>.sock"
    <% end %>
    <% 4.times do |w| %>
        listen "127.0.0.1:<%= 4000 + w %>"
    <% end %>
  }

  sendfile on;
  tcp_nopush on;
  gzip on;
  gzip_disable "MSIE [1-6]\.(?!.*SV1)";

}
