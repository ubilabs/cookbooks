safe do

  local :path => "/backup/:kind/:id"

  s3 do
    key <%= node[:backup][:amazon][:access_key] %>
    secret <%= node[:backup][:amazon][:secret_access_key] %>
    bucket <%= node[:backup][:amazon][:bucket] %>
    path ":kind/:id"
  end

  keep do
    local 20
    s3 <%= node[:backup][:keep_backups] %>
  end

  mysqldump do
    options "-ceKq --single-transaction --create-options"

    user <%= node[:mysql][:username] %>
    password <%= node[:mysql][:password] %>
    #socket "/var/run/mysqld/mysqld.sock"

    database <%= node[:mysql][:database].to_sym %>
  end

  tar do
    options "-h" # dereference symlinks

    archive <%= node[:mysql][:database] %> do
      files <%= node[:deploy][:deploy_to] %>
    end

  end

end
