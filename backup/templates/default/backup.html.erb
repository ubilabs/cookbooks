safe do
  app_name = "<% node[:backup][:app] %>"

  local :path => "/backup/:kind/:id"

  s3 do
    key "<%= node[:backup][:amazon][:access_key] %>"
    secret "<%= node[:backup][:amazon][:secret_access_key] %>"
    bucket "<%= node[:backup][:amazon][:bucket] %>"
    path ":kind/:id"
  end

  keep do
    local 20
    s3 <%= node[:backup][:keep_backups] %>
  end

  mysqldump do
    options "-ceKq --single-transaction --create-options"

    user "<%= node[:backup][:database_user] %>"
    password "<%= node[:mysql][:server_root_password] %>"

    if node[:deploy][app_name][:databse][:host]
      host "<%= node[:deploy][app_name][:database][:host] %>"
    end

    database <%= node[:backup][:database].to_sym %>
  end

end
