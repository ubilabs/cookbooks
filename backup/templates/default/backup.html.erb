safe do

  local :path => "/backup/:kind/:id"

  s3 do
    key "<%= node[:backup][:amazon][:access_key] %>"
    secret "<%= node[:backup][:amazon][:secret_access_key] %>"
    bucket "<%= node[:backup][:amazon][:bucket] %>"
    path ":kind/:id"
  end

  keep do
    local 20
    s3 <%= node[:backup][:keep_backups] %>
  end

  # TODO: set mysql dump for all apps in node[:deploy][app_name]
  mysqldump do
    options "-ceKq --single-transaction --create-options"

    user "<%= node[:backup][:database_user] %>"
    password "<%= node[:mysql][:server_root_password] %>"

    host "<%= node[:deploy][app_name][:database][:host] %>"

    database <%= node[:backup][:database].to_sym %>
  end

end
