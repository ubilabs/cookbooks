safe do

  local :path => "/backup/:kind/:id"

  s3 do
    key "<%= node[:backup][:amazon][:access_key] %>"
    secret "<%= node[:backup][:amazon][:secret_access_key] %>"
    bucket "<%= node[:backup][:amazon][:bucket] %>"
    path ":kind/:id"
  end

  keep do
    local 20
    s3 <%= node[:backup][:keep_backups] %>
  end

  node[:deploy].each do |application, deploy|
    deploy = node[:deploy][application]

    mysqldump do
      options "-ceKq --single-transaction --create-options"

      user "<%= node[:backup][:database_user] %>"
      password "<%= node[:mysql][:server_root_password] %>"

      host "<%= deploy[:database][:host] %>"

      database <%= node[:backup][:database].to_sym %>
    end
  end

end
